name: Manual History Repair

on:
  workflow_dispatch: 

jobs:
  repair:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install and Configure Exercism CLI
        env:
          EXERCISM_TOKEN: ${{ secrets.EXERCISM_TOKEN }}
        run: |
          # Descarga e instalación del binario oficial
          curl -L https://github.com/exercism/cli/releases/download/v3.5.4/exercism-3.5.4-linux-x86_64.tar.gz -o exercism.tar.gz
          tar -xf exercism.tar.gz
          sudo mv exercism /usr/local/bin/
          
          # Configuración del entorno
          mkdir -p /home/runner/.config/exercism
          exercism configure --token=$EXERCISM_TOKEN

      - name: Mass Enrich Exercises from Solutions
        run: |
          BASE_DIR="solutions"
          
          if [ ! -d "$BASE_DIR" ]; then
            echo "Error: Carpeta $BASE_DIR no encontrada."
            exit 1
          fi

          # Iteración analítica de la estructura de archivos
          for TRACK_PATH in $(find "$BASE_DIR" -maxdepth 1 -mindepth 1 -type d); do
            TRACK_NAME=$(basename "$TRACK_PATH")
            
            for EXERCISE_PATH in $(find "$TRACK_PATH" -maxdepth 1 -mindepth 1 -type d); do
              SLUG=$(basename "$EXERCISE_PATH")
              
              echo "--- Sincronizando: $TRACK_NAME/$SLUG ---"
              
              # Descarga del bundle completo desde la API v3
              exercism download --track=$TRACK_NAME --exercise=$SLUG || true
              
              # Sincronización robusta:
              # -r: Recursivo para incluir carpetas de tests/src
              # -u: Update (solo copia si el archivo es nuevo o falta)
              # Esto evita el error de 'omitting directory' y protege tu solución
              SOURCE_DIR="$HOME/exercism/$TRACK_NAME/$SLUG"
              if [ -d "$SOURCE_DIR" ]; then
                cp -ru "$SOURCE_DIR"/. "$BASE_DIR/$TRACK_NAME/$SLUG/" || true
              fi
            done
          done

      - name: Commit and Push Changes
        run: |
          git config user.name "History Repair"
          git config user.email "actions@github.com"
          git add .
          
          if git diff --staged --quiet; then
            echo " No hay archivos faltantes."
          else
            git commit -m "refactor: reconstrucción total (tests y docs obtenidos)"
            git push origin main
          fi
