name: Manual History Repair

on:
  workflow_dispatch: 

jobs:
  repair:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install and Configure Exercism CLI
        env:
          EXERCISM_TOKEN: ${{ secrets.EXERCISM_TOKEN }}
        run: |
          curl -L https://github.com/exercism/cli/releases/download/v3.5.4/exercism-3.5.4-linux-x86_64.tar.gz -o exercism.tar.gz
          tar -xf exercism.tar.gz
          sudo mv exercism /usr/local/bin/
          mkdir -p /home/runner/.config/exercism
          exercism configure --token=$EXERCISM_TOKEN

      - name: Mass Enrich and Purge Config Files
        run: |
          BASE_DIR="solutions"
          
          if [ ! -d "$BASE_DIR" ]; then
            echo "Error: Carpeta $BASE_DIR no encontrada."
            exit 1
          fi

          # 1. Purga de archivos config.json preexistentes
          echo "Buscando y eliminando residuos de config.json..."
          find "$BASE_DIR" -name "config.json" -path "*/.exercism/*" -delete

          # 2. Iteraci贸n y Sincronizaci贸n
          for TRACK_PATH in $(find "$BASE_DIR" -maxdepth 1 -mindepth 1 -type d); do
            TRACK_NAME=$(basename "$TRACK_PATH")
            
            for EXERCISE_PATH in $(find "$TRACK_PATH" -maxdepth 1 -mindepth 1 -type d); do
              SLUG=$(basename "$EXERCISE_PATH")
              
              echo "--- Sincronizando: $TRACK_NAME/$SLUG ---"
              
              exercism download --track=$TRACK_NAME --exercise=$SLUG || true
              
              SOURCE_DIR="$HOME/exercism/$TRACK_NAME/$SLUG"
              if [ -d "$SOURCE_DIR" ]; then
                # Copia recursiva y actualizaci贸n
                cp -ru "$SOURCE_DIR"/. "$BASE_DIR/$TRACK_NAME/$SLUG/" || true
                
                # Eliminaci贸n inmediata del nuevo config.json para que no se vuelva a subir
                rm -f "$BASE_DIR/$TRACK_NAME/$SLUG/.exercism/config.json"
              fi
            done
          done

      - name: Commit and Push Changes
        run: |
          git config user.name "History Repair"
          git config user.email "actions@github.com"
          git add .
          
          if git diff --staged --quiet; then
            echo "Sistema limpio y completo."
          else
            git commit -m "refactor: Datos recuperados"
            git push origin main
          fi
